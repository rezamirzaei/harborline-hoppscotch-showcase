---
- name: Deploy Harborline stack via Docker Compose
  hosts: harborline
  gather_facts: false
  become: true

  vars:
    harborline_dir: "{{ harborline_dir | default('/opt/harborline') }}"
    harborline_api_image: "{{ harborline_api_image | default('ghcr.io/your-org/harborline-commerce-api:latest') }}"

    harborline_compose_src: "{{ playbook_dir }}/../../../deploy/docker-compose.prod.yml"
    harborline_config_src: "{{ playbook_dir }}/../../../config"

  pre_tasks:
    - name: Ensure Python is present (Debian/Ubuntu)
      ansible.builtin.raw: test -x /usr/bin/python3 || (apt-get update -y && apt-get install -y python3)
      changed_when: false

    - name: Gather facts
      ansible.builtin.setup:

  tasks:
    - name: Install OS packages (Debian/Ubuntu)
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        update_cache: true
      when: ansible_facts.os_family == "Debian"

    - name: Install Docker (if missing)
      ansible.builtin.shell: |
        set -euo pipefail
        if ! command -v docker >/dev/null 2>&1; then
          curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
          sh /tmp/get-docker.sh
        fi
      args:
        executable: /bin/bash

    - name: Ensure docker service is enabled and started
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true

    - name: Check docker compose availability
      ansible.builtin.command: docker compose version
      register: docker_compose_check
      changed_when: false
      failed_when: false

    - name: Install docker compose plugin (Debian/Ubuntu)
      ansible.builtin.apt:
        name: docker-compose-plugin
        update_cache: true
      when:
        - docker_compose_check.rc != 0
        - ansible_facts.os_family == "Debian"

    - name: Create deployment directory
      ansible.builtin.file:
        path: "{{ harborline_dir }}"
        state: directory
        mode: "0755"

    - name: Copy docker compose file
      ansible.builtin.copy:
        src: "{{ harborline_compose_src }}"
        dest: "{{ harborline_dir }}/docker-compose.yml"
        mode: "0644"

    - name: Copy config directory (env files)
      ansible.builtin.copy:
        src: "{{ harborline_config_src }}/"
        dest: "{{ harborline_dir }}/config/"
        mode: "0644"

    - name: Write .env (image tag)
      ansible.builtin.copy:
        dest: "{{ harborline_dir }}/.env"
        content: |
          HARBORLINE_API_IMAGE={{ harborline_api_image }}
        mode: "0644"

    - name: Pull and start services
      ansible.builtin.command: docker compose up -d --pull always
      args:
        chdir: "{{ harborline_dir }}"

